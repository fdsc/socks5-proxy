# vinny-socks5-proxy.conf Vinogradov S.V. © 2021
# Этот файл - справка по конфигурации
# Если прокси запускается без параметров, то он берёт из рабочей директории файл vinny-socks5-proxy.conf
# Иначе принимает единственный параметр: путь к файлу конфигурации

# Решётка - символ однострочного комментария. Строка должна начинаться с этого символа и вся пропускается

# error - это ключевое слово, генерирующее ошибку при парсинге. Файл с незакомментированной линией с error будет прочитан с ошибкой.
# Это может быть полезно, если файл заранее не сконфигурирован и вы хотите напомнить себе (или другим) о том, что файл нужно сконфигурировать
# error You must configure the configuration file

# Ключевые слова регистронезависимы. То есть можно указать как "ERROR", так и "error"
# Каждая строка имеет формат "ключевое_слово пробелы_или_табуляции значение"

# Общий лог-файл. Сюда выводятся сообщения о старте сервиса
# info выводит, собственно, сообщение о старте. Если строки с info нет, то нет и сообщения о старте
# Если log_file отсутствует в конфигурации (закомментирован), то логирование вестись не будет
log_file        vinny-socks5-proxy.log
info            Starting...

# Логирование непредвиденных ошибок может происходит в стандартный вывод (для ошибок или простой)
# Кроме этого, логирование ошибок в conf-файле идёт только в стандартный вывод
# Логирование ошибок в trusts-файле идёт в лог-файл прослушивателя


# listen начинает раздел прослушивателя. Таких разделов может быть несколько
# Указываем IP-адрес для прослушивания соединений от клиентов
listen          127.0.0.1
# port - указываем порт для прослушивания соединений от клиентов
port            30080
# Это значение передаётся в функцию Socket.Listen для определения длины очереди на подключение. В самом прокси ограничений на подключения нет
max_connections 64

# Для каждого прослушивателя ведётся свой лог. Если он не указан, лог не ведётся.
# Во избежании ошибок, лог должен отличаться от общего лога и от логов других прослушивателей (иначе они могут начать конфликтовать)
# Для данного прослушивателя в рабочей директории процесса создастся лог vinny-socks5-proxy@30080.log
# $$$port$$$ - является подстановочным символом. На его место будет подставлен номер порта для прослушивания
log_file        vinny-socks5-proxy@$$$port$$$.log
# Стартовое сообщение в логе. Если info нет, то стартового сообщения не будет. Вместо $$$addr$$$ подставляется адрес прослушивания
info            Starting $$$addr$$$...

# Эти строки указывают данные для аутентификации. Они могут повторяться многократно. Сначала user, потом password - порядок важен
# Если строк нет, сервер допускает подключение только без авторизации. Если строки есть - только с авторизацией
user            user
password        pwd

# Это разрешения на запросы подключения по разным адресам
# accept - разрешение, reject - запрет
# ipv4 accept означает, что клиент может запрашивать соединение непосредственно с IPv4-адресами целевого сервера
# (скажем, Telegram или TorBrowser так делают)
# ipv6 reject - аналогично, только reject означает, что соединения по ipv6 будут запрещены
# domain accept - означает, что клиент может запрашивать соединение, идентифицируя целевой сервер через доменное имя
# Это обычное поведение для большинства программ и браузеров
ipv4            accept
ipv6            reject
domain          accept

# Стандартная настройка приёма соединения для барузеров и большинства программ была бы в domain accept, остальное - reject
# Для TorBrowser и Telegram настройка была бы обратная: domain reject, остальные строки - accept


# debug - уровень логирования. 5-ый уровень - максимальный. Он логирует размер каждой пересылки между сервером и клиентом
# 4-ый уровень подробно логирует запросы на подключение.
# Например, при запросе на подключение ya.ru будет логироваться IP-адрес по которому происходит соединение
# 3-ий уровень логирует то же, что и второй, плюс успешный вход пользователя и неуспешные попытки подключения под одному из целевых адресов (но успешные по другому адресу)
# 2-ой уровень регистрирует только факт начала подключения (в том числе, все IP-адреса и доменные имена), факт окончания подключения (со статистикой)
# Ошибки, неудачные подключения логируются всегда (чтобы их отключить, нужно закомментировать строку log_file)
# 0 также может полностью отключить логирование (будет логироваться только старт прослушивателя и непредвиденные ошибки)
debug           4


# Когда происходит приём информации прокси-сервером, он может произойти лишь малой порцией (30 байтов, например)
# Можно немного подождать, чтобы информации стало больше
# Отрицательное значение SleepTime указывает на то, что ждать вообще не надо.
# Ноль - это вызов Thread.Sleep(0) (см. документацию по .NET)
# В остальном это ожидание SleepTime миллисекунд до того, как отдавать данные другой стороне
# Например, SleepTimeTo 100 вызовет следующее поведение
# Получаем информацию от клиента
# Если информации менее, чем SleepTimeToBytes, то ждём 100 миллисекунд, нет ли ещё информации от клиента
# Если новая информация поступила, возвращаемся выше на шаг получения информации и ожидания
# Если информации больше нет - отправляем всю информацию

# SleepTimeBytes - это размер данных, имея который сервер отправит его без ожидания
# Даже если SleepTime отрицательное значение, но SleepTimeBytes - положительный, 
# сервер будет задерживать отправку полученных данных, если после получания информации он, без ожидания, увидел, что есть ещё информация
# Это позволяет укрупнить порции передаваемых сообщений, но вставляет задержку в передачу
# Пример. SleepTimeTo -1, SleepTimeToBytes 1400
# Сервер получает данные размером Size
# Сервер проверяет, если Size >= SleepTimeToBytes, то сервер отправит сообщение сразу же
# Если нет (размер мал), то он проверяет, есть ли ещё ожидающие данные
# Если данные есть, возвращается на шаг получения данных (и объединяет две порции в одну)
# Если данных больше нет, посылает те, что есть без ожидания
# SleepTimeToBytes имеет смысл устанавливать в размер MTU

# SleepTimeTo и SleepTimeTo относятся к информации, получаемой от клиента
# SleepTimeFrom и SleepTimeFromBytes относятся к информации, получаемой от целевого сервера

SleepTimeTo        0
SleepTimeToBytes   1400
SleepTimeFrom      0
SleepTimeFromBytes 512

# Файл доверия к доменам (фильтрация доступа по именам доменов)
domain_trusts   trusts.txt


# Начало нового прослушивателя. Он будет работать на другом порту с другими настройками
listen          127.0.0.1
port            30081

log_file        vinny-socks5-proxy@$$$port$$$.log
info            Starting $$$addr$$$...

# Здесь мы видим, что разрешены запросы к серверам только с использованием доменных имён,
# то есть браузер (или другой клиент) не имеет права сам разрешать доменные имена - типичная настройка под браузер
ipv4            reject
ipv6            reject
domain          accept

# Прокси на данном порту работает без авторизации, так как user не указан
